name: GH-HOSTED-WINDOWS

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Show system info
        run: |
          systeminfo
          whoami

      - name: Install Tailscale (outbound only)
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest $url -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --accept-dns=false

      - name: Install getscreen.me (install only)
        run: |
          $exe = "$env:TEMP\getscreen.exe"
          Invoke-WebRequest "https://getscreen.me/download/windows" -OutFile $exe
          Start-Process $exe -ArgumentList "/S" -Wait

      - name: Install Stardesk (install only)
        run: |
          $exe = "$env:TEMP\stardesk.exe"
          Invoke-WebRequest "https://www.stardesk.app/download/windows" -OutFile $exe
          Start-Process $exe -ArgumentList "/S" -Wait

      - name: Open Sandboxels (headless)
        run: |
          Start-Process "msedge.exe" "https://sandboxels.r74n.com"
          Start-Sleep 15

      - name: Collect installed programs
        run: |
          Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* |
          Select DisplayName |
          Out-File installed.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gh-hosted-output
          path: |
            installed.txt
